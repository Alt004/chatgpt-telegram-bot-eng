import telebot
import openai
from dotenv.main import load_dotenv
import json
import os
import datetime


DEFAULT_SYSTEM_PROMPT = "You are a helpful assistant."
PRICE_1K = 0.002  # price per 1k rokens in USD
DATE_FORMAT = "%d.%m.%Y %H:%M:%S"  # date format for logging


# load .env file with secrets
load_dotenv()

# Load OpenAI API credentials from .env file
openai.api_key = os.getenv("OPENAI_API_KEY")

# Create a new Telebot instance
bot = telebot.TeleBot(os.getenv("TELEGRAM_API_KEY"))

# –ü–æ–ª—É—á–∞–µ–º –∞–π–¥–∏ –∞–¥–º–∏–Ω–∞, –∫–æ—Ç–æ—Ä–æ–º—É –≤ –ª—Å –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –ª–æ–≥–∏
ADMIN_ID = int(os.getenv("ADMIN_ID"))

# File with users and global token usage data
DATAFILE = "data.json"


"""======================FUNCTIONS======================="""


# Function to check if the user is in the data file
def is_user_exists(user_id: int) -> bool:
    if user_id in data:
        return True
    else:
        return False


# Function to add new user to the data file
def add_new_user(user_id: int, name: str, username: str) -> None:
    data[user_id] = DEFAULT_DATA.copy()
    data[user_id]["name"] = name
    if username is not None:
        data[user_id]["username"] = '@'+username
    else:
        data[user_id]["username"] = "None"


# Function to update the JSON file with relevant data
def update_json_file(new_data) -> None:
    with open(DATAFILE, "w") as file:
        json.dump(new_data, file, indent=4)


# Function to get the user's prompt
def get_user_prompt(user_id: int) -> str:
    if data[user_id].get("prompt") is None:
        return DEFAULT_SYSTEM_PROMPT
    else:
        return str(data[user_id]["prompt"])


# Function to call the OpenAI API and get the response
def call_chatgpt(user_request: str, prev_answer=None, system_prompt=DEFAULT_SYSTEM_PROMPT):
    messages = [{"role": "system", "content": system_prompt}]

    if prev_answer is not None:
        messages.extend([{"role": "assistant", "content": prev_answer},
                         {"role": "user", "content": user_request}])
        print("\n–ó–∞–ø—Ä–æ—Å —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º ü§©")
    else:
        messages.append({"role": "user", "content": user_request})
        print("\n–ó–∞–ø—Ä–æ—Å –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞")

    return openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        max_tokens=3000,
        messages=messages
    )


"""========================SETUP========================="""


# Check if the file exists
if os.path.isfile(DATAFILE):
    # Read the contents of the file
    with open(DATAFILE, "r") as f:
        data = json.load(f)

    # Convert keys to integers (except for the first key)
    for key in list(data.keys())[1:]:
        data[int(key)] = data.pop(key)
else:
    data = {"global": {"requests": 0, "tokens": 0},
            ADMIN_ID: {"requests": 0, "tokens": 0, "balance": 777777, "lastdate": "01-05-2023 00:00:00"}}
    # Create the file with default values
    update_json_file(data)

# Default values for new users, who are not in the data file
DEFAULT_DATA = {"requests": 0, "tokens": 0, "balance": 30000,
                "name": "None", "username": "None", "lastdate": "11-09-2001 00:00:00"}


# Calculate the price per token in cents
PRICE_CENTS = PRICE_1K / 10

# Session token and request counters
session_tokens, request_number = 0, 0


"""=======================HANDLERS======================="""


# Define the handler for the /start command
@bot.message_handler(commands=["start"])
def handle_start_command(message):
    user = message.from_user

    # –ï—Å–ª–∏ —é–∑–µ—Ä —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ, —Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–¥–æ—Ä–æ–≤–∞–µ–º—Å—è –∏ –≤—ã—Ö–æ–¥–∏–º, –∏–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –±–∞–∑—É
    if is_user_exists(user.id):
        bot.send_message(message.chat.id, "–ú–∞–≥–¥—ã—á –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ üí™")  # –º–± –≤—ã–¥–∞–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–∑ –ø—É–ª–∞
        return
    else:
        add_new_user(user.id, user.first_name, user.username)
        update_json_file(data)

        welcome_string = f"{user.first_name}, —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º ü§ù\n\n" \
                         f"–ù–∞ —Ç–≤–æ–π –±–∞–ª–∞–Ω—Å –∑–∞—á–∏—Å–ª–µ–Ω–æ 30–∫ —Ç–æ–∫–µ–Ω–æ–≤ ü§ë\n\n" \
                         f"–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/help - —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥\n/balance - –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–æ–≤\n" \
                         f"/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤\n/prompt - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç\n"
        bot.send_message(message.chat.id, welcome_string)

        new_user_log = f"\n–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.full_name} " \
                       f"@{user.username} {user.id}"
        print(new_user_log)
        bot.send_message(ADMIN_ID, new_user_log)


# Define the handler for the /stop command
@bot.message_handler(commands=["stop"])
def handle_stop_command(message):
    if message.from_user.id == ADMIN_ID:
        bot.reply_to(message, "Stopping the script...")
        bot.stop_polling()
    else:
        bot.reply_to(message, "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –±–æ—Ç–∞")


# Define the handler for the /help command
@bot.message_handler(commands=["help"])
def handle_help_command(message):
    bot.reply_to(message, "–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:\n\n"
                          "/start - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ\n/help - —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ (–≤—ã –∑–¥–µ—Å—å)\n\n"
                          "/balance - –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–æ–≤\n/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤\n\n"
                          "/prompt - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤–æ–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç\n"
                          "/reset_prompt - –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–æ–º–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n")


# Define the handler for the /balance command
@bot.message_handler(commands=["balance"])
def handle_balance_command(message):
    user_id = message.from_user.id

    # –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å –≤ –±–∞–∑–µ, —Ç–æ –≤—ã–¥–∞–µ–º –µ–≥–æ –±–∞–ª–∞–Ω—Å, –∏–Ω–∞—á–µ –ø—Ä–æ—Å–∏–º –µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    if is_user_exists(user_id):
        balance = data[user_id]["balance"]
        bot.reply_to(message, f"–í–∞—à –±–∞–ª–∞–Ω—Å: {balance} —Ç–æ–∫–µ–Ω–æ–≤")
    else:
        bot.reply_to(message, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ. –ù–∞–ø–∏—à–∏—Ç–µ /start")


# Define the handler for the /stats command
@bot.message_handler(commands=["stats"])
def handle_stats_command(message):
    user_id = message.from_user.id

    # –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å –≤ –±–∞–∑–µ, —Ç–æ –≤—ã–¥–∞–µ–º –µ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –∏–Ω–∞—á–µ –ø—Ä–æ—Å–∏–º –µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    if is_user_exists(user_id):
        user_stats = data[user_id]["requests"], data[user_id]["tokens"], data[user_id]["lastdate"]
        bot.reply_to(message, f"–ó–∞–ø—Ä–æ—Å–æ–≤: {user_stats[0]}\n"
                              f"–¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {user_stats[1]}\n"
                              f"–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å: {user_stats[2]}")
    else:
        bot.reply_to(message, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ. –ù–∞–ø–∏—à–∏—Ç–µ /start")


# Define the handler for the /prompt command
@bot.message_handler(commands=["prompt"])
def handle_prompt_command(message):
    user = message.from_user
    answer = ""

    prompt = message.text[len("/prompt"):].strip()

    # –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å –≤ –±–∞–∑–µ, —Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç, –∏–Ω–∞—á–µ –ø—Ä–æ—Å–∏–º –µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    if is_user_exists(user.id):
        if prompt:
            data[user.id]["prompt"] = prompt
            update_json_file(data)
            bot.reply_to(message, f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ–º–ø—Ç: `{prompt}`", parse_mode="Markdown")
            print("\n–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ–º–ø—Ç: " + prompt)
        else:
            if "prompt" in data[user.id]:
                answer = f"*–¢–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç:* `{str(data[user.id]['prompt'])}`\n\n"

            answer += "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç - —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º –≤–º–µ—Å—Ç–µ "\
                      "—Å –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –¥–ª—è –ø—Ä–∏–¥–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ —Å—Ç–∏–ª—è –æ—Ç–≤–µ—Ç–∞. \n\n"\
                      "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É `/prompt`"\
                      " –∏ —Ç—Ä–µ–±—É–µ–º—ã–π —Ç–µ–∫—Å—Ç –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: \n\n"\
                      "`/prompt –¢—ã YodaGPT - AI –º–æ–¥–µ–ª—å, "\
                      "–∫–æ—Ç–æ—Ä–∞—è –Ω–∞ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—á–∞–µ—Ç –≤ —Å—Ç–∏–ª–µ –ô–æ–¥—ã –∏–∑ Star Wars`"

            bot.reply_to(message, answer,  parse_mode="Markdown")
            print("\nNo text provided.")
    else:
        bot.reply_to(message, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ. –ù–∞–ø–∏—à–∏—Ç–µ /start")


# Define the handler for the /reset_prompt command
@bot.message_handler(commands=["reset_prompt"])
def handle_reset_prompt_command(message):
    user = message.from_user

    # –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å –≤ –±–∞–∑–µ, —Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç, –∏–Ω–∞—á–µ –ø—Ä–æ—Å–∏–º –µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    if is_user_exists(user.id):
        if data[user.id].get("prompt") is not None:
            del data[user.id]["prompt"]
            update_json_file(data)
            bot.reply_to(message, f"–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–±—Ä–æ—à–µ–Ω –¥–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
            print("\n–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–±—Ä–æ—à–µ–Ω –¥–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        else:
            bot.reply_to(message, f"–£ –≤–∞—Å —É–∂–µ —Å—Ç–æ–∏—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç!")
            print("\n–£ –≤–∞—Å —É–∂–µ —Å—Ç–æ–∏—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç!")
    else:
        bot.reply_to(message, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ. –ù–∞–ø–∏—à–∏—Ç–µ /start")


# Define the message handler for incoming messages
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    global session_tokens, request_number, data
    user = message.from_user

    # –ï—Å–ª–∏ —é–∑–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –æ—Ç–≤–µ—Ç –±–æ—Ç—É –¥—Ä—É–≥–æ–≥–æ —é–∑–µ—Ä–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ, —Ç–æ –≤—ã—Ö–æ–¥–∏–º, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ (issue #27)
    if message.reply_to_message is not None and message.reply_to_message.from_user.id != bot.get_me().id:
        print(f"\nUser {user.full_name} @{user.username} replied to another user, skip")
        return

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –±–∞–∑–µ, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    if not is_user_exists(user.id):
        add_new_user(user.id, user.first_name, user.username)

        new_user_string = f"\n–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.full_name} " \
                          f"@{user.username} {user.id}"
        print(new_user_string)
        bot.send_message(ADMIN_ID, new_user_string)

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω—Ñ—É –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ —Ñ–∞–π–ª
        update_json_file(data)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–∫–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
    if data[user.id]["balance"] <= 0:
        bot.reply_to(message, "–£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Ç–æ–∫–µ–Ω—ã. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å")
        return

    # Send the user's message to OpenAI API and get the response
    # –ï—Å–ª–∏ —é–∑–µ—Ä –Ω–∞–ø–∏—Å–∞–ª –∑–∞–ø—Ä–æ—Å –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –∑–∞–ø—Ä–æ—Å
    try:
        if message.reply_to_message is not None and message.reply_to_message.from_user.id == bot.get_me().id:
            response = call_chatgpt(message.text, message.reply_to_message.text, get_user_prompt(user.id))
        else:
            response = call_chatgpt(message.text, system_prompt=get_user_prompt(user.id))
    except openai.error.RateLimitError:
        print("\n–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤!")
        bot.reply_to(message, "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ")
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –ø–æ –ê–ü–ò –≤ —Ç–æ–∫–µ–Ω–∞—Ö
    request_tokens = response["usage"]["total_tokens"]  # same: response.usage.total_tokens
    session_tokens += request_tokens
    request_number += 1

    # –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
    data["global"]["tokens"] += request_tokens
    data["global"]["requests"] += 1

    # –ï—Å–ª–∏ —é–∑–µ—Ä –Ω–µ –∞–¥–º–∏–Ω, —Ç–æ —Å–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã —Å –±–∞–ª–∞–Ω—Å–∞
    if user.id != ADMIN_ID:
        data[user.id]["balance"] -= request_tokens

    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∏ –¥–∞—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    data[user.id]["tokens"] += request_tokens
    data[user.id]["requests"] += 1
    data[user.id]["lastdate"] = datetime.datetime.now().strftime(DATE_FORMAT)

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω—Ñ—É –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ç–æ–∫–µ–Ω–∞—Ö –≤ —Ñ–∞–π–ª
    update_json_file(data)

    # –°—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ü–µ–Ω—Ç–∞—Ö
    request_price = request_tokens * PRICE_CENTS

    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ª–æ–≥ —Ä–∞–±–æ—Ç—ã –¥–ª—è —é–∑–µ—Ä–∞
    user_log = f"\n\n\n–¢–æ–∫–µ–Ω—ã: {request_tokens} –∑–∞ ¬¢{round(request_price, 3)} " \
               f"\n–ë–∏–ø-–±–æ–ø"

    # Send the response back to the user
    if message.chat.type == "private":
        bot.send_message(message.chat.id, response.choices[0].message.content + user_log)
    else:
        bot.reply_to(message, response.choices[0].message.content + user_log)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ª–æ–≥ —Ä–∞–±–æ—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∞
    admin_log = (f"–ó–∞–ø—Ä–æ—Å {request_number}: {request_tokens} –∑–∞ ¬¢{round(request_price, 3)}\n"
                 f"–°–µ—Å—Å–∏—è: {session_tokens} –∑–∞ ¬¢{round(session_tokens * PRICE_CENTS, 3)}\n"
                 f"–Æ–∑–µ—Ä: {user.full_name} "
                 f"@{user.username} {user.id}\n"
                 f"–ß–∞—Ç: {message.chat.title} {message.chat.id}"
                 f"\n{data['global']} ¬¢{round(data['global']['tokens'] * PRICE_CENTS, 3)}")

    # –ü–∏—à–µ–º –ª–æ–≥ —Ä–∞–±–æ—Ç—ã –≤ –∫–æ–Ω—Å–æ–ª—å
    print("\n" + admin_log)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥ —Ä–∞–±–æ—Ç—ã –∞–¥–º–∏–Ω—É –≤ —Ç–≥
    if message.chat.id != ADMIN_ID:
        bot.send_message(ADMIN_ID, admin_log)


# Start the bot
print("---—Ä–∞–±–æ—Ç–∞–µ–º---")
bot.infinity_polling()

# –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã
bot.send_message(ADMIN_ID, "–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
